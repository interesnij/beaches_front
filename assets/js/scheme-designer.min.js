/**
 * Generated on 11/18/2024
 */

var SchemeDesigner;(s=>{s.Layer=class{constructor(e,t){if(this.zIndex=0,this.active=!0,this.visible=!0,this.objects=[],0==e.length)throw new Error("Empty layer id");this.id=e,s.Tools.configure(this,t)}removeObject(t){this.objects=this.objects.filter(e=>e!==t)}removeObjects(){this.objects=[]}getObjects(){return this.objects}addObject(e){e.setLayerId(this.id),this.objects.push(e)}setZIndex(e){this.zIndex=e}setActive(e){this.active=e}setVisible(e){this.visible=e}isVisible(){return this.visible}isActive(){return this.active}getZIndex(){return this.zIndex}getId(){return this.id}}})(SchemeDesigner=SchemeDesigner||{}),(a=>{a.Scheme=class{constructor(e,t){this.renderingRequestId=0,this.devicePixelRatio=1,this.defaultCursorStyle="default",this.cacheSchemeRatio=2,this.cacheOnHover=!0,this.background=null,this.changedObjects=[],this.requestFrameAnimation=a.Polyfill.getRequestAnimationFrameFunction(),this.cancelFrameAnimation=a.Polyfill.getCancelAnimationFunction(),this.devicePixelRatio=a.Polyfill.getDevicePixelRatio(),t&&a.Tools.configure(this,t.options),this.view=new a.View(e,this.background),this.scrollManager=new a.ScrollManager(this),this.zoomManager=new a.ZoomManager(this),this.eventManager=new a.EventManager(this),this.mapManager=new a.MapManager(this),this.storageManager=new a.StorageManager(this),t&&(a.Tools.configure(this.scrollManager,t.scroll),a.Tools.configure(this.zoomManager,t.zoom),a.Tools.configure(this.mapManager,t.map),a.Tools.configure(this.storageManager,t.storage),a.Tools.configure(this.eventManager,t.event)),a.Tools.disableElementSelection(this.view.getCanvas()),this.resize()}resize(){this.view.resize(),this.mapManager.resize(),this.zoomManager.resetScale()}getEventManager(){return this.eventManager}getScrollManager(){return this.scrollManager}getZoomManager(){return this.zoomManager}getStorageManager(){return this.storageManager}getMapManager(){return this.mapManager}getWidth(){return this.view.getWidth()}getHeight(){return this.view.getHeight()}requestFrameAnimationApply(e){return this.requestFrameAnimation.call(window,e)}cancelAnimationFrameApply(e){return this.cancelFrameAnimation.call(window,e)}clearContext(){var e=this.view.getContext();return e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,this.getWidth(),this.getHeight()),e.restore(),this}requestRenderAll(){return this.renderingRequestId||(this.renderingRequestId=this.requestFrameAnimationApply(()=>{this.renderAll()})),this}render(){this.storageManager.getTree(),this.zoomManager.setScale(this.zoomManager.getScaleWithAllObjects()),this.scrollManager.toCenter(),this.updateCache(!1),this.requestDrawFromCache()}getVisibleBoundingRect(){var e=this.zoomManager.getScale(),t=this.getWidth()/e,s=this.getHeight()/e,i=-this.scrollManager.getScrollLeft()/e,e=-this.scrollManager.getScrollTop()/e;return{left:i,top:e,right:i+t,bottom:e+s}}renderAll(){this.renderingRequestId&&(this.cancelAnimationFrameApply(this.renderingRequestId),this.renderingRequestId=0),this.eventManager.sendEvent("beforeRenderAll"),this.clearContext(),this.view.drawBackground();var e,t=this.getVisibleBoundingRect(),s=this.storageManager.findNodesByBoundingRect(null,t),i={};for(e of this.storageManager.getSortedLayers())for(var r of s)for(var n of r.getObjectsByLayer(e.getId())){var o=n.getId();void 0===i[o]&&(i[o]=!0,n.render(this,this.view))}this.mapManager.drawMap(),this.eventManager.sendEvent("afterRenderAll")}addLayer(e){this.storageManager.addLayer(e)}removeLayer(e){this.storageManager.removeLayer(e)}getCanvas(){return this.view.getCanvas()}setCursorStyle(e){return this.view.getCanvas().style.cursor=e,this}getDefaultCursorStyle(){return this.defaultCursorStyle}drawFromCache(){if(!this.cacheView)return!1;this.renderingRequestId&&(this.cancelAnimationFrameApply(this.renderingRequestId),this.renderingRequestId=0),this.clearContext();var e=this.storageManager.getObjectsBoundingRect();return this.view.drawBackground(),this.view.getContext().drawImage(this.cacheView.getCanvas(),0,0,e.right,e.bottom),this.mapManager.drawMap(),!0}requestDrawFromCache(){return this.renderingRequestId||(this.renderingRequestId=this.requestFrameAnimationApply(()=>{this.drawFromCache()})),this}updateCache(e){if(this.cacheView||(r=this.storageManager.getImageStorage("scheme-cache"),this.cacheView=new a.View(r.getCanvas(),this.background)),e)for(var t of this.changedObjects){var s=this.storageManager.getLayerById(t.getLayerId());s instanceof a.Layer&&s.isVisible()&&(t.clear(this,this.cacheView),t.render(this,this.cacheView))}else{var i,r=this.storageManager.getObjectsBoundingRect(),e=1/this.zoomManager.getScaleWithAllObjects()*this.cacheSchemeRatio,n=r.right*e,r=r.bottom*e,n=(this.cacheView.setDimensions({width:n,height:r}),this.cacheView.getContext().scale(e,e),this.cacheView.drawBackground(),this.storageManager.getSortedLayers());for(i of n)for(var o of i.getObjects())o.render(this,this.cacheView)}this.changedObjects=[]}addChangedObject(e){this.changedObjects.push(e)}setCacheSchemeRatio(e){this.cacheSchemeRatio=e}getCAcheSchemeRatio(){return this.cacheSchemeRatio}setCacheOnHover(e){this.cacheOnHover=e}getCacheOnHover(){return this.cacheOnHover}useSchemeCache(){var e=this.storageManager.getObjectsDimensions().width*this.zoomManager.getScale()/this.getWidth();return!!(this.cacheSchemeRatio&&e<=this.cacheSchemeRatio)}getView(){return this.view}getCacheView(){return this.cacheView}setBackground(e){this.background=e}getBackground(){return this.background}}})(SchemeDesigner=SchemeDesigner||{}),(n=>{n.SchemeObject=class{constructor(e){this.active=!0,this.rotation=0,this.isHovered=!1,this.cursorStyle="pointer",this.renderFunction=function(){},this.clearFunction=function(){},this.id=n.Tools.generateUniqueId(),n.Tools.configure(this,e),this.params=e}setLayerId(e){this.layerId=e}getLayerId(){return this.layerId}getId(){return this.id}getX(){return this.x}getY(){return this.y}getWidth(){return this.width}getHeight(){return this.height}getParams(){return this.params}render(e,t){this.renderFunction(this,e,t)}clear(e,t){this.clearFunction(this,e,t)}click(e,t,s){return"function"==typeof this.clickFunction?this.clickFunction(this,t,s,e):null}mouseOver(e,t,s){return"function"==typeof this.mouseOverFunction?this.mouseOverFunction(this,t,s,e):null}mouseLeave(e,t,s){return"function"==typeof this.mouseLeaveFunction?this.mouseLeaveFunction(this,t,s,e):null}checkPointInObject(e,t,s){return"function"!=typeof this.pointInObjectFunction||this.pointInObjectFunction(this,e,t,s)}setX(e){this.x=e}setY(e){this.y=e}setWidth(e){this.width=e}setHeight(e){this.height=e}setCursorStyle(e){this.cursorStyle=e}setRotation(e){this.rotation=e}setRenderFunction(e){this.renderFunction=e}setClickFunction(e){this.clickFunction=e}setClearFunction(e){this.clearFunction=e}setMouseOverFunction(e){this.mouseOverFunction=e}setMouseLeaveFunction(e){this.mouseLeaveFunction=e}setPointInObjectFunction(e){this.pointInObjectFunction=e}getBoundingRect(){return{left:this.x,top:this.y,right:this.x+this.width,bottom:this.y+this.height}}getOuterBoundingRect(){var e,t,s,i,r=this.getBoundingRect();return this.rotation?(i={x:(r.left+r.right)/2,y:(r.top+r.bottom)/2},e=n.Tools.rotatePointByAxis({x:this.x,y:this.y},i,this.rotation),t=n.Tools.rotatePointByAxis({x:this.x,y:this.y+this.height},i,this.rotation),s=n.Tools.rotatePointByAxis({x:this.x+this.width,y:this.y},i,this.rotation),i=n.Tools.rotatePointByAxis({x:this.x+this.width,y:this.y+this.height},i,this.rotation),{left:Math.min(e.x,t.x,s.x,i.x),top:Math.min(e.y,t.y,s.y,i.y),right:Math.max(e.x,t.x,s.x,i.x),bottom:Math.max(e.y,t.y,s.y,i.y)}):r}getRotation(){return this.rotation}isActive(){return this.active}setActive(e){this.active=e}}})(SchemeDesigner=SchemeDesigner||{}),(i=>{i.ImageStorage=class{constructor(e,t){this.id="scheme-designer-image-storage-"+i.Tools.getRandomString()+"-"+e,this.scheme=t;let s=document.getElementById(e);s||((s=document.createElement("canvas")).id=this.id,s.style.display="none",this.scheme.getCanvas().parentNode.appendChild(s)),this.canvas=s,this.context=this.canvas.getContext("2d")}setImageData(e,t,s){this.setDimensions({width:t,height:s}),this.context.putImageData(e,0,0)}setDimensions(e){this.canvas.width=e.width,this.canvas.height=e.height}getCanvas(){return this.canvas}getContext(){return this.context}}})(SchemeDesigner=SchemeDesigner||{}),(SchemeDesigner||(SchemeDesigner={})).Polyfill=class{static getRequestAnimationFrameFunction(){var e;for(e of["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"])if(window.hasOwnProperty(e))return window[e];return function(e){return window.setTimeout(e,1e3/60)}}static getCancelAnimationFunction(){return window.cancelAnimationFrame||window.clearTimeout}static getDevicePixelRatio(){var e;for(e of["devicePixelRatio","webkitDevicePixelRatio","mozDevicePixelRatio"])if(window.hasOwnProperty(e))return window[e];return 1}},(e=>{class h{static configure(e,t){if(t)for(var s in t){var i=t[s],s="set"+h.capitalizeFirstLetter(s);"function"==typeof e[s]&&e[s].call(e,i)}}static capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}static clone(e){return JSON.parse(JSON.stringify(e))}static pointInRect(e,t,s){let i=!1,r=e.x,n=e.y;var o,a;return s&&(s=-s,o=(t.left+t.right)/2,a=(t.top+t.bottom)/2,e=h.rotatePointByAxis(e,{x:o,y:a},s),r=e.x,n=e.y),i=t.left<=r&&t.right>=r&&t.top<=n&&t.bottom>=n?!0:i}static rotatePointByAxis(e,t,s){return s=s*Math.PI/180,{x:t.x+(e.x-t.x)*Math.cos(s)-(e.y-t.y)*Math.sin(s),y:t.y+(e.x-t.x)*Math.sin(s)+(e.y-t.y)*Math.cos(s)}}static rectIntersectRect(e,t){return!(e.top>t.bottom||e.bottom<t.top||e.right<t.left||e.left>t.right)}static filterObjectsByBoundingRect(e,t){var s,i=[];for(s of t){var r=s.getOuterBoundingRect();this.rectIntersectRect(r,e)&&i.push(s)}return i}static filterLayersObjectsByBoundingRect(e,t){var s,i={};for(s in t){var r=t[s];i[s]=h.filterObjectsByBoundingRect(e,r)}return i}static parseMaxStyle(e,t,s){let i;return"string"==typeof e?(i=parseInt(e,10),-1!==e.indexOf("%")&&(i=i/100*t.parentNode[s])):i=e,i}static isConstrainedValue(e){return null!=e&&"none"!==e}static getConstraintDimension(e,t,s){var i=document.defaultView,r=e.parentNode,n=i.getComputedStyle(e)[t],i=i.getComputedStyle(r)[t],t=this.isConstrainedValue(n),o=this.isConstrainedValue(i),a=Number.POSITIVE_INFINITY;return t||o?Math.min(t?this.parseMaxStyle(n,e,s):a,o?this.parseMaxStyle(i,r,s):a):null}static getConstraintWidth(e){return this.getConstraintDimension(e,"max-width","clientWidth")}static getConstraintHeight(e){return this.getConstraintDimension(e,"max-height","clientHeight")}static getMaximumWidth(e){var t,s,i=e.parentNode;return i?(s=parseInt(this.getStyle(i,"padding-left"),10),t=parseInt(this.getStyle(i,"padding-right"),10),i=i.clientWidth-s-t,(s=this.getConstraintWidth(e))?Math.min(i,s):i):e.clientWidth}static getMaximumHeight(e){var t,s,i=e.parentNode;return i?(s=parseInt(this.getStyle(i,"padding-top"),10),t=parseInt(this.getStyle(i,"padding-bottom"),10),i=i.clientHeight-s-t,(s=this.getConstraintHeight(e))?Math.min(i,s):i):e.clientHeight}static getStyle(e,t){return e.currentStyle?e.currentStyle[t]:document.defaultView.getComputedStyle(e,null).getPropertyValue(t)}static generateUniqueId(){return this.idNumber++,this.idNumber}static touchSupported(){return"ontouchstart"in window}static sortObject(t){var s=Object.keys(t),i=s.length,r=(s.sort(),{});for(let e=0;e<i;e++){var n=s[e];r[n]=t[n]}return r}static getRandomString(){return Math.random().toString(36).substr(2,9)}static disableElementSelection(e){var t;for(t of["-webkit-touch-callout","-webkit-user-select","-khtml-user-select","-moz-user-select","-ms-user-select","user-select","outline"])e.style[t]="none"}static getPointer(e,t){var s="touchend"===e.type?"changedTouches":"touches";return e[s]&&e[s][0]?2==e[s].length?(e[s][0][t]+e[s][1][t])/2:e[s][0][t]:e[t]}}h.idNumber=0,e.Tools=h})(SchemeDesigner=SchemeDesigner||{}),(s=>{s.View=class{constructor(e,t=null){this.scrollLeft=0,this.scrollTop=0,this.scale=0,this.width=0,this.height=0,this.background=null,this.canvas=e,this.background=t,this.background?this.context=this.canvas.getContext("2d",{alpha:!1}):this.context=this.canvas.getContext("2d")}getCanvas(){return this.canvas}getContext(){return this.context}setScrollLeft(e){this.scrollLeft=e}setScrollTop(e){this.scrollTop=e}setScale(e){this.scale=e}getScrollLeft(){return this.scrollLeft}getScrollTop(){return this.scrollTop}getScale(){return this.scale}setDimensions(e){this.canvas.width=e.width,this.canvas.height=e.height,this.width=e.width,this.height=e.height}getWidth(){return this.width}getHeight(){return this.height}applyTransformation(){this.context.setTransform(this.scale,0,0,this.scale,this.scrollLeft,this.scrollTop)}resize(){var e=Math.max(0,Math.floor(s.Tools.getMaximumWidth(this.getCanvas()))),t=Math.max(0,Math.floor(s.Tools.getMaximumHeight(this.getCanvas())));this.setDimensions({width:e,height:t})}drawBackground(){var e;return!!this.background&&((e=this.getContext()).fillStyle=this.background,e.save(),e.setTransform(1,0,0,1,0,0),e.fillRect(0,0,this.width,this.height),e.restore(),!0)}}})(SchemeDesigner=SchemeDesigner||{}),(s=>{s.EventManager=class{constructor(e){this.isDragging=!1,this.leftButtonDown=!1,this.hoveredObjects=[],this.lastTouchEndTime=0,this.doubleTapDelay=300,this.scheme=e,this.setLastClientPosition({x:this.scheme.getWidth()/2,y:this.scheme.getHeight()/2}),this.bindEvents()}bindEvents(){this.scheme.getCanvas().addEventListener("mousedown",e=>{this.onMouseDown(e)}),this.scheme.getCanvas().addEventListener("mouseup",e=>{this.onMouseUp(e)}),this.scheme.getCanvas().addEventListener("click",e=>{this.onClick(e)}),this.scheme.getCanvas().addEventListener("dblclick",e=>{this.onDoubleClick(e)}),this.scheme.getCanvas().addEventListener("mousemove",e=>{this.onMouseMove(e)}),this.scheme.getCanvas().addEventListener("mouseout",e=>{this.onMouseOut(e)}),this.scheme.getCanvas().addEventListener("mouseenter",e=>{this.onMouseEnter(e)}),this.scheme.getCanvas().addEventListener("contextmenu",e=>{this.onContextMenu(e)}),this.scheme.getCanvas().addEventListener("mousewheel",e=>{this.onMouseWheel(e)}),this.scheme.getCanvas().addEventListener("DOMMouseScroll",e=>{this.onMouseWheel(e)}),this.scheme.getCanvas().addEventListener("touchstart",e=>{this.touchDistance=0,this.onMouseDown(e)}),this.scheme.getCanvas().addEventListener("touchmove",t=>{if(!t.targetTouches)return!1;if(1==t.targetTouches.length)this.onMouseMove(t);else if(2==t.targetTouches.length){var s=t.targetTouches[0],i=t.targetTouches[1],i=Math.sqrt(Math.pow(i.pageX-s.pageX,2)+Math.pow(i.pageY-s.pageY,2));let e=0;this.touchDistance&&(e=i-this.touchDistance),this.touchDistance=i,e&&this.scheme.getZoomManager().zoomToPointer(t,e/5)}t.preventDefault()}),this.scheme.getCanvas().addEventListener("touchend",e=>{var t=(new Date).getTime();this.lastTouchEndTime&&t-this.lastTouchEndTime<=this.doubleTapDelay?e.preventDefault():this.onMouseUp(e),this.lastTouchEndTime=t}),this.scheme.getCanvas().addEventListener("touchcancel",e=>{this.onMouseUp(e)}),window.addEventListener("resize",e=>{var t=this.scheme.getZoomManager().getScale();this.scheme.resize(),this.scheme.requestRenderAll(),this.scheme.getZoomManager().zoomByFactor(t)||this.scheme.getZoomManager().setScale(this.scheme.getZoomManager().getScaleWithAllObjects())})}onMouseDown(e){this.leftButtonDown=!0,this.setLastClientPositionFromEvent(e)}onMouseUp(e){this.leftButtonDown=!1,this.setLastClientPositionFromEvent(e),this.isDragging&&(this.scheme.setCursorStyle(this.scheme.getDefaultCursorStyle()),this.scheme.requestRenderAll()),setTimeout(()=>{this.isDragging=!1},1)}onClick(e){if(!this.isDragging){var t,s=this.findObjectsForEvent(e);for(t of s)t.click(e,this.scheme,this.scheme.getView()),this.scheme.addChangedObject(t),this.sendEvent("clickOnObject",t);s.length&&(this.scheme.requestRenderAll(),this.scheme.updateCache(!0))}}onDoubleClick(e){var t=this.scheme.getZoomManager();t.zoomToPointer(e,t.getClickZoomDelta())}onContextMenu(e){}onMouseMove(e){var t,s;this.leftButtonDown&&(s=this.getCoordinatesFromEvent(e),t=Math.abs(s.x-this.getLastClientX()),s=Math.abs(s.y-this.getLastClientY()),1<t||1<s)&&(this.isDragging=!0,this.scheme.setCursorStyle("move")),this.isDragging?this.scheme.getScrollManager().handleDragging(e):this.handleHover(e)}handleHover(t){this.setLastClientPositionFromEvent(t);var s,i=this.findObjectsForEvent(t);let r=!1,n=!1;if(this.hoveredObjects.length)for(var o of this.hoveredObjects){let e=!1;for(var a of i)a==o&&(e=!0);e||(o.isHovered=!1,s=o.mouseLeave(t,this.scheme,this.scheme.getView()),this.scheme.addChangedObject(o),this.sendEvent("mouseLeaveObject",o),!1!==s&&(r=!0),n=!0)}if(!this.hoveredObjects.length||n)for(var e of i)e.isHovered=!0,this.scheme.setCursorStyle(e.cursorStyle),!1!==e.mouseOver(t,this.scheme,this.scheme.getView())&&(r=!0),this.scheme.addChangedObject(e),this.sendEvent("mouseOverObject",e,t);(this.hoveredObjects=i).length||this.scheme.setCursorStyle(this.scheme.getDefaultCursorStyle()),r&&(this.scheme.requestRenderAll(),this.scheme.getCacheOnHover())&&this.scheme.updateCache(!0)}onMouseOut(e){this.setLastClientPositionFromEvent(e),this.leftButtonDown=!1,this.isDragging=!1,this.scheme.requestRenderAll()}onMouseEnter(e){}onMouseWheel(e){return this.scheme.getZoomManager().handleMouseWheel(e)}setLastClientPositionFromEvent(e){e=this.getCoordinatesFromEvent(e);this.setLastClientPosition(e)}findObjectsForEvent(e){e=this.getCoordinatesFromEvent(e);return this.scheme.getStorageManager().findObjectsByCoordinates(e)}getCoordinatesFromEvent(e){var t=this.scheme.getCanvas().getBoundingClientRect();return{x:s.Tools.getPointer(e,"clientX")-t.left,y:s.Tools.getPointer(e,"clientY")-t.top}}setLastClientPosition(e){this.lastClientPosition=e}getLastClientX(){return this.lastClientPosition.x}getLastClientY(){return this.lastClientPosition.y}sendEvent(t,s,i){t="schemeDesigner."+t;if("function"==typeof CustomEvent){let e=s;void 0!==i&&(e={data:s,originalEvent:i});i=new CustomEvent(t,{detail:e});this.scheme.getCanvas().dispatchEvent(i)}else{i=document.createEvent("CustomEvent");i.initCustomEvent(t,!1,!1,s),this.scheme.getCanvas().dispatchEvent(i)}}setDoubleTapDelay(e){this.doubleTapDelay=e}}})(SchemeDesigner=SchemeDesigner||{}),(s=>{s.MapManager=class{constructor(e){this.isDragging=!1,this.leftButtonDown=!1,this.lastTouchEndTime=0,this.scheme=e}getScaledSchemeRect(){var e=this.scheme.getStorageManager().getObjectsBoundingRect(),t=e.right,e=e.bottom,s=this.mapView.getWidth(),i=this.mapView.getHeight(),r=s/i<t/e?s/t:i/e,t=t*r,e=e*r;return{scaleFactor:r,width:t,height:e,leftOffset:(s-t)/2,topOffset:(i-e)/2}}getRectBoundingRect(e){var t=this.scheme.getVisibleBoundingRect(),s=t.left*e.scaleFactor+e.leftOffset,i=t.top*e.scaleFactor+e.topOffset;return{left:s,top:i,right:s+(t.right-t.left)*e.scaleFactor,bottom:i+(t.bottom-t.top)*e.scaleFactor}}drawMap(){var e,t,s=this.scheme.getCacheView();return!(!this.mapView||!s||(e=this.getScaledSchemeRect(),(t=this.mapView.getContext()).clearRect(0,0,this.mapView.getWidth(),this.mapView.getHeight()),t.drawImage(s.getCanvas(),e.leftOffset,e.topOffset,e.width,e.height),t=this.getRectBoundingRect(e),this.drawRect(t),0))}drawRect(e){var t=this.mapView.getContext(),s=(t.lineWidth=1,t.strokeStyle="#000",t.strokeRect(e.left,e.top,e.right-e.left,e.bottom-e.top),2*this.mapView.getWidth()),i=2*this.mapView.getHeight(),r="rgba(0, 0, 0, 0.1)";t.fillStyle=r,t.strokeStyle=r,t.lineWidth=0,t.fillRect(0,0,e.left,i),t.fillRect(e.left,0,e.right-e.left,e.top),t.fillRect(e.right,0,s,i),t.fillRect(e.left,e.bottom,e.right-e.left,i)}setMapCanvas(e){this.mapCanvas=e,this.mapView=new s.View(this.mapCanvas),this.bindEvents(),s.Tools.disableElementSelection(this.mapCanvas)}resize(){this.mapView&&this.mapView.resize()}bindEvents(){this.mapCanvas.addEventListener("mousedown",e=>{this.onMouseDown(e)}),this.mapCanvas.addEventListener("mouseup",e=>{this.onMouseUp(e)}),this.mapCanvas.addEventListener("mousemove",e=>{this.onMouseMove(e)}),this.mapCanvas.addEventListener("mouseout",e=>{this.onMouseOut(e)}),this.mapCanvas.addEventListener("click",e=>{this.onClick(e)}),this.mapCanvas.addEventListener("mousewheel",e=>{this.onMouseWheel(e)}),this.mapCanvas.addEventListener("DOMMouseScroll",e=>{this.onMouseWheel(e)})}onMouseWheel(e){var t,s=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0;return s&&(t=this.getCoordinatesFromEvent(e),this.scrollByCoordinates(t),this.scheme.getZoomManager().zoomToCenter(s)),e.preventDefault()&&!1}onMouseDown(e){this.leftButtonDown=!0,this.setLastClientPositionFromEvent(e)}onMouseOut(e){this.setLastClientPositionFromEvent(e),this.leftButtonDown=!1,this.isDragging=!1}setCursorStyle(e){return this.mapCanvas.style.cursor=e,this}onMouseUp(e){this.leftButtonDown=!1,this.setLastClientPositionFromEvent(e),this.isDragging&&(e=this.getCoordinatesFromEvent(e),this.scrollByCoordinates(e),this.setCursorStyle("default")),setTimeout(()=>{this.isDragging=!1},1)}onMouseMove(e){var t,s;this.leftButtonDown&&(t=this.getCoordinatesFromEvent(e),s=Math.abs(t.x-this.getLastClientX()),t=Math.abs(t.y-this.getLastClientY()),1<s||1<t)&&(this.isDragging=!0,this.setCursorStyle("move")),this.isDragging&&(s=this.getCoordinatesFromEvent(e),this.scrollByCoordinates(s))}setLastClientPositionFromEvent(e){e=this.getCoordinatesFromEvent(e);this.setLastClientPosition(e)}setLastClientPosition(e){this.lastClientPosition=e}getLastClientX(){return this.lastClientPosition.x}getLastClientY(){return this.lastClientPosition.y}getRealCoordinates(e){var t=this.getScaledSchemeRect(),s=this.scheme.getZoomManager().getScale(),i=this.scheme.getStorageManager().getObjectsBoundingRect(),r=this.getRectBoundingRect(t),n=r.right-r.left,n=(e.x-t.leftOffset-n/2)/t.scaleFactor,e=(e.y-t.topOffset-(r.bottom-r.top)/2)/t.scaleFactor;return{x:(n-i.left)*s,y:(e-i.top)*s}}scrollByCoordinates(e){e=this.getRealCoordinates(e);this.scheme.getScrollManager().scroll(-e.x,-e.y)}onClick(e){this.isDragging||(e=this.getCoordinatesFromEvent(e),this.scrollByCoordinates(e))}getCoordinatesFromEvent(e){var t=this.mapCanvas.getBoundingClientRect();return{x:s.Tools.getPointer(e,"clientX")-t.left,y:s.Tools.getPointer(e,"clientY")-t.top}}}})(SchemeDesigner=SchemeDesigner||{}),(SchemeDesigner||(SchemeDesigner={})).ScrollManager=class{constructor(e){this.scrollLeft=0,this.scrollTop=0,this.maxHiddenPart=.5,this.draggable=!0,this.draggableLeft=!0,this.draggableTop=!0,this.scheme=e}getScrollLeft(){return this.scrollLeft}getScrollTop(){return this.scrollTop}scroll(e,t){var s=this.scheme.getStorageManager().getObjectsBoundingRect(),i=this.scheme.getZoomManager().getScale(),r=-s.left*i,n=-s.top*i,o=-s.right*i,a=-s.bottom*i;r+=this.scheme.getWidth()*this.maxHiddenPart,n+=this.scheme.getHeight()*this.maxHiddenPart,o+=this.scheme.getWidth()*(1-this.maxHiddenPart),(t=n<t?n:t)<(a+=this.scheme.getHeight()*(1-this.maxHiddenPart))&&(t=a),this.scrollLeft=e=(e=r<e?r:e)<o?o:e,this.scrollTop=t,this.scheme.getView().setScrollTop(t),this.scheme.getView().setScrollLeft(e),this.scheme.getView().applyTransformation(),this.scheme.useSchemeCache()?this.scheme.requestDrawFromCache():this.scheme.requestRenderAll(),this.scheme.getEventManager().sendEvent("scroll",{left:e,top:t,maxScrollLeft:r,maxScrollTop:n,minScrollLeft:o,minScrollTop:a,boundingRect:s,scale:i})}toCenter(){var e=this.scheme.getStorageManager().getObjectsBoundingRect(),t=this.scheme.getStorageManager().getObjectsDimensions(),s=this.scheme.getZoomManager().getScale(),i=this.scheme.getWidth()/s-t.width,t=this.scheme.getHeight()/s-t.height,i=(i/2-e.left)*s,t=(t/2-e.top)*s;this.scroll(i,t)}handleDragging(e){var t,s;this.draggable&&(t=this.scheme.getEventManager().getLastClientX(),s=this.scheme.getEventManager().getLastClientY(),this.scheme.getEventManager().setLastClientPositionFromEvent(e),e=this.scheme.getEventManager().getLastClientX()-t,t=this.scheme.getEventManager().getLastClientY()-s,s=this.draggableLeft?e+this.getScrollLeft():this.getScrollLeft(),e=this.draggableTop?t+this.getScrollTop():this.getScrollTop(),this.scroll(s,e))}setMaxHiddenPart(e){this.maxHiddenPart=e}setDraggable(e){this.draggable=e}getDraggable(){return this.draggable}setDraggableLeft(e){this.draggableLeft=e}getDraggableLeft(){return this.draggableLeft}setDraggableTop(e){this.draggableTop=e}getDraggableTop(){return this.draggableTop}},(g=>{g.StorageManager=class{constructor(e){this.treeDepth=6,this.layers={},this.scheme=e}getLayerById(e){return void 0!==this.layers[e]?this.layers[e]:null}getVisibleObjects(){let e=[];var t,s=this.getVisibleObjectsByLayers();for(t in s){var i=s[t];void 0!==i&&i.length&&(e=[...e,...i])}return e}getVisibleObjectsByLayers(){var e,t,s={};for(e of this.getSortedLayers())e.isVisible()&&void 0!==(t=e.getObjects())&&t.length&&(s[e.getId()]=t);return s}setLayers(e){for(var t of e)this.addLayer(t)}getLayers(){return this.layers}getSortedLayers(){var e,t=[];for(e in this.layers){var s=this.layers[e];s.isVisible()&&t.push(s)}return t.sort(function(e,t){return e.getZIndex()<t.getZIndex()?-1:e.getZIndex()>t.getZIndex()?1:0}),t}addLayer(e){if(this.getLayerById(e.getId())instanceof g.Layer)throw new Error("Layer with such id already exist");this.layers[e.getId()]=e}removeLayers(){this.layers={},this.applyStructureChange()}removeLayer(e){delete this.layers[e],this.applyStructureChange()}setLayerVisibility(e,t){e=this.getLayerById(e);if(!(e instanceof g.Layer))throw new Error("Layer not found");e.setVisible(t),this.applyStructureChange()}setLayerActivity(e,t){e=this.getLayerById(e);if(!(e instanceof g.Layer))throw new Error("Layer not found");e.setActive(t)}applyStructureChange(){this.requestBuildTree(),this.reCalcObjectsBoundingRect(),this.scheme.updateCache(!1),this.scheme.requestRenderAll()}findObjectsByCoordinates(e){var t=[],s=e.x,e=e.y,i=(s-=this.scheme.getScrollManager().getScrollLeft(),e-=this.scheme.getScrollManager().getScrollTop(),s/=this.scheme.getZoomManager().getScale(),e/=this.scheme.getZoomManager().getScale(),this.getTree()),i=this.findNodeByCoordinates(i,{x:s,y:e});let r={};var n,o={x:s,y:e};for(n in r=i?i.getObjectsByLayers():r){var a,h,c=this.getLayerById(n);if(c.isActive())for(a of r[n])a.isActive()&&(h=a.getBoundingRect(),g.Tools.pointInRect(o,h,a.getRotation()))&&(h={x:o.x-a.getX(),y:o.y-a.getY()},a.checkPointInObject(h,this.scheme,this.scheme.getView()))&&t.push(a)}return t}getObjectsBoundingRect(){return this.objectsBoundingRect||(this.objectsBoundingRect=this.calculateObjectsBoundingRect()),this.objectsBoundingRect}getObjectsDimensions(){var e=this.getObjectsBoundingRect();return{width:e.right-e.left,height:e.bottom-e.top}}reCalcObjectsBoundingRect(){this.objectsBoundingRect=null}calculateObjectsBoundingRect(){let e,t,s,i;var r=this.getVisibleObjects();if(r.length)for(var n of r){n=n.getBoundingRect();(null==e||n.top<e)&&(e=n.top),(null==t||n.left<t)&&(t=n.left),(null==s||n.right>s)&&(s=n.right),(null==i||n.bottom>i)&&(i=n.bottom)}return{left:t,top:e,right:s,bottom:i}}setTreeDepth(e){this.treeDepth=e}requestBuildTree(){this.rootTreeNode=null}getTree(){return this.rootTreeNode||(this.rootTreeNode=this.buildTree()),this.rootTreeNode}buildTree(){var e=this.getObjectsBoundingRect();return this.rootTreeNode=new o(null,e,this.getVisibleObjectsByLayers(),0),this.explodeTreeNodes(this.rootTreeNode,this.treeDepth),this.rootTreeNode}explodeTreeNodes(e,t){if(this.explodeTreeNode(e),0<--t)for(var s of e.getChildren())this.explodeTreeNodes(s,t)}explodeTreeNode(e){var t=e.getBoundingRect(),s=e.getDepth()+1,i=g.Tools.clone(t),r=g.Tools.clone(t),t=(s%2==1?(n=(t.right-t.left)/2,i.right=i.right-n,r.left=r.left+n):(n=(t.bottom-t.top)/2,i.bottom=i.bottom-n,r.top=r.top+n),g.Tools.filterLayersObjectsByBoundingRect(i,e.getObjectsByLayers())),n=g.Tools.filterLayersObjectsByBoundingRect(r,e.getObjectsByLayers()),i=new o(e,i,t,s),t=new o(e,r,n,s);e.addChild(i),e.addChild(t),e.removeObjects()}findNodeByCoordinates(e,t){e=e.getChildByCoordinates(t);return e?e.isLastNode()?e:this.findNodeByCoordinates(e,t):null}findNodesByBoundingRect(e,t){var s,i,r=[];for(s of(e=e||this.getTree()).getChildrenByBoundingRect(t))if(s.isLastNode())r.push(s);else for(i of this.findNodesByBoundingRect(s,t))r.push(i);return r}showNodesParts(){var e,t=this.getTree().getLastChildren(),s=this.scheme.getView().getContext();for(e of t){var i=e.getBoundingRect().left+this.scheme.getScrollManager().getScrollLeft(),r=e.getBoundingRect().top+this.scheme.getScrollManager().getScrollTop(),n=e.getBoundingRect().right-e.getBoundingRect().left,o=e.getBoundingRect().bottom-e.getBoundingRect().top;s.lineWidth=1,s.strokeStyle="black",s.rect(i,r,n,o),s.stroke()}}getImageStorage(e){return new g.ImageStorage(e,this.scheme)}};class o{constructor(e,t,s,i){this.children=[],this.objectsByLayers={},this.parent=e,this.boundingRect=t,this.objectsByLayers=s,this.depth=i}addChild(e){this.children.push(e)}getObjects(){let e=[];for(var t in this.objectsByLayers){t=this.objectsByLayers[t];void 0!==t&&t.length&&(e=[...e,...t])}return e}getObjectsByLayer(e){return void 0!==this.objectsByLayers[e]?this.objectsByLayers[e]:[]}getObjectsByLayers(){return this.objectsByLayers}getChildren(){return this.children}isLastNode(){return 0<Object.keys(this.objectsByLayers).length}getLastChildren(){var e,t,s=[];for(e of this.children)if(e.isLastNode())s.push(e);else for(t of e.getLastChildren())s.push(t);return s}getChildByCoordinates(e){for(var t of this.children)if(g.Tools.pointInRect(e,t.getBoundingRect()))return t;return null}getChildrenByBoundingRect(e){var t,s=[];for(t of this.children)g.Tools.rectIntersectRect(t.getBoundingRect(),e)&&s.push(t);return s}removeObjects(){this.objectsByLayers={}}getBoundingRect(){return this.boundingRect}getDepth(){return this.depth}}g.TreeNode=o})(SchemeDesigner=SchemeDesigner||{}),(SchemeDesigner||(SchemeDesigner={})).ZoomManager=class{constructor(e){this.scale=1,this.zoomCoefficient=1.04,this.clickZoomDelta=14,this.padding=.1,this.maxScale=5,this.zoomByWheel=!0,this.scheme=e}zoom(e){e=this.getFactorByDelta(e);return this.zoomByFactor(e)}getFactorByDelta(e){return Math.pow(this.zoomCoefficient,e)}setScale(e){e=this.scale/e;return this.zoomByFactor(e)}getScaleWithAllObjects(){var e=this.scheme.getStorageManager().getObjectsBoundingRect(),t=(e.right-e.left)*(this.padding+1)/this.scheme.getWidth(),e=(e.bottom-e.top)*(this.padding+1)/this.scheme.getHeight();return e<t?t:e}getMaxZoomScale(){var e=this.scheme.getStorageManager().getObjectsDimensions(),t=this.scheme.getWidth()*this.maxScale/e.width,e=this.scheme.getHeight()*this.maxScale/e.height;return e<t?t:e}getMinZoomScale(){var e=this.scheme.getStorageManager().getObjectsDimensions(),t=this.scheme.getWidth()*(1-this.padding)/e.width,e=this.scheme.getHeight()*(1-this.padding)/e.height;return t<e?t:e}canZoomByFactor(e){var t=this.scale*e;let s=!1;return s=e<1?this.getMinZoomScale()<t:this.getMaxZoomScale()>t}zoomByFactor(e){this.renderAllTimer&&clearTimeout(this.renderAllTimer);var t=this.scale,s=t*e,i=this.getMaxZoomScale(),r=this.getMinZoomScale();let n=s;s=(n=(n=n>i?i:n)<r?r:n)!=t;return this.scheme.getEventManager().sendEvent("zoom",{oldScale:t,newScale:n,factor:e,success:s}),s&&(this.scale=n,this.scheme.getView().setScale(n),this.scheme.getView().applyTransformation(),this.scheme.useSchemeCache()?(this.scheme.requestDrawFromCache(),this.renderAllTimer=setTimeout(()=>{this.scheme.requestRenderAll()},300)):this.scheme.requestRenderAll(),!0)}getScale(){return this.scale}resetScale(){this.scale=1}handleMouseWheel(e){var t;if(this.zoomByWheel)return(t=e.wheelDelta?e.wheelDelta/40:e.detail?-e.detail:0)&&this.zoomToPointer(e,t),e.preventDefault()&&!1}zoomToPointer(e,t){this.scheme.getEventManager().setLastClientPositionFromEvent(e),this.zoomToPoint({x:this.scheme.getEventManager().getLastClientX(),y:this.scheme.getEventManager().getLastClientY()},t)}zoomToCenter(e){this.zoomToPoint({x:this.scheme.getWidth()/2,y:this.scheme.getHeight()/2},e)}zoomToPoint(e,t){var s,i,r=this.scheme.getZoomManager().getScale();this.scheme.getZoomManager().zoom(t)&&(t=this.scheme.getZoomManager().getScale(),i={x:e.x/r,y:e.y/r},r=r/t,s=((e={x:e.x/t,y:e.y/t}).x-i.x)*t,e=(e.y-i.y)*t,i=this.scheme.getScrollManager().getScrollLeft()/r,t=this.scheme.getScrollManager().getScrollTop()/r,this.scheme.getScrollManager().scroll(i+s,t+e))}setPadding(e){this.padding=e}setMaxScale(e){this.maxScale=e}setZoomCoefficient(e){this.zoomCoefficient=e}setClickZoomDelta(e){this.clickZoomDelta=e}getClickZoomDelta(){return this.clickZoomDelta}setZoomByWheel(e){this.zoomByWheel=e}getZoomByWheel(){return this.zoomByWheel}};